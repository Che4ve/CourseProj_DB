---
name: –ú–∏–≥—Ä–∞—Ü–∏—è –≤ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–§–ò–ù–ê–õ–¨–ù–ê–Ø)
overview: "–ü–µ—Ä–µ–¥–µ–ª–∫–∞ Next.js + Supabase –ø—Ä–æ–µ–∫—Ç–∞ –≤ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å NestJS backend, Prisma ORM, PostgreSQL. –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç \"5 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤\" (UUID‚â†TEXT‚â†INTEGER‚â†BOOLEAN‚â†TIMESTAMPTZ), –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –≤ Prisma middleware –±–µ–∑ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏."
todos:
  - id: phase0-docs
    content: –°–æ–∑–¥–∞—Ç—å docs/requirements-checklist.md
    status: completed
  - id: phase1-monorepo-setup
    content: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pnpm workspaces + Turborepo
    status: completed
  - id: phase1-move-frontend
    content: –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å Next.js –≤ apps/frontend
    status: completed
    dependencies:
      - phase1-monorepo-setup
  - id: phase1-cleanup
    content: –£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç—ã, vitest, package-lock.json
    status: completed
    dependencies:
      - phase1-move-frontend
  - id: phase2-db-schema-types
    content: –°–æ–∑–¥–∞—Ç—å schema.prisma —Å 13 —Ç–∞–±–ª–∏—Ü–∞–º–∏, –ö–ê–ñ–î–ê–Ø >= 5 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤
    status: completed
  - id: phase2-manual-migrations
    content: –î–æ–±–∞–≤–∏—Ç—å _manual_migrations –≤ schema
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase2-sql-triggers
    content: –°–æ–∑–¥–∞—Ç—å 001_triggers.sql (–∞—É–¥–∏—Ç —Å user_id + –∞–≥—Ä–µ–≥–∞—Ç—ã)
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase2-sql-functions
    content: –°–æ–∑–¥–∞—Ç—å 002_functions.sql (—Å–∫–∞–ª—è—Ä–Ω–∞—è + —Ç–∞–±–ª–∏—á–Ω–∞—è)
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase2-sql-views
    content: –°–æ–∑–¥–∞—Ç—å 003_views.sql (3 VIEW)
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase2-sql-indexes
    content: –°–æ–∑–¥–∞—Ç—å 004_indexes.sql
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase2-apply-sql-script
    content: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å apply-sql.ts —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
    status: completed
    dependencies:
      - phase2-manual-migrations
  - id: phase2-seed
    content: "Seed: 800 habits, 10000 checkins, faker.seed(12345)"
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase3-backend-init
    content: –°–æ–∑–¥–∞—Ç—å NestJS –≤ apps/backend
    status: completed
  - id: phase3-prisma-middleware-safe
    content: "–ü–†–ò–û–†–ò–¢–ï–¢: Prisma middleware —Å –ü–ê–†–ê–ú–ï–¢–†–ò–ó–ê–¶–ò–ï–ô (set_config –∏–ª–∏ $executeRaw)"
    status: completed
    dependencies:
      - phase3-backend-init
      - phase2-db-schema-types
  - id: phase3-auth
    content: Auth + JWT + bcrypt + AsyncLocalStorage
    status: completed
    dependencies:
      - phase3-backend-init
  - id: phase3-crud
    content: CRUD —ç–Ω–¥–ø–æ–π–Ω—Ç—ã —á–µ—Ä–µ–∑ Prisma
    status: completed
    dependencies:
      - phase3-auth
      - phase2-db-schema-types
  - id: phase3-reports-safe-sql
    content: –û—Ç—á—ë—Ç—ã —Å $queryRaw (–ü–ê–†–ê–ú–ï–¢–†–ò–ó–û–í–ê–ù–ù–´–ô SQL)
    status: completed
    dependencies:
      - phase3-crud
  - id: phase3-batch
    content: Batch import —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    status: completed
    dependencies:
      - phase3-crud
  - id: phase3-swagger
    content: Swagger /api/docs
    status: completed
    dependencies:
      - phase3-backend-init
  - id: phase4-remove-supabase
    content: –£–¥–∞–ª–∏—Ç—å Supabase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    status: completed
    dependencies:
      - phase1-move-frontend
  - id: phase4-api-client
    content: –°–æ–∑–¥–∞—Ç—å API –∫–ª–∏–µ–Ω—Ç
    status: completed
    dependencies:
      - phase4-remove-supabase
  - id: phase4-rewrite-actions
    content: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å server actions
    status: completed
    dependencies:
      - phase4-api-client
      - phase3-crud
  - id: phase4-middleware-no-fetch
    content: Middleware –ë–ï–ó —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (jwtVerify)
    status: completed
    dependencies:
      - phase4-api-client
  - id: phase5-docker
    content: docker-compose.yml
    status: completed
  - id: phase5-env-docker-fix
    content: ".env: backend:3001 –¥–ª—è Docker, localhost:3001 –¥–ª—è local"
    status: completed
    dependencies:
      - phase5-docker
  - id: phase6-perf-analysis
    content: EXPLAIN ANALYZE + docs/perf.md
    status: completed
    dependencies:
      - phase2-sql-indexes
  - id: phase7-schema-doc-types
    content: docs/schema.md —Å –ø–æ–¥—Å—á—ë—Ç–æ–º —Ç–∏–ø–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã
    status: completed
    dependencies:
      - phase2-db-schema-types
  - id: phase7-docs
    content: –û—Å—Ç–∞–ª—å–Ω—ã–µ docs/
    status: completed
    dependencies:
      - phase0-docs
  - id: phase7-readme
    content: README —Å quick start
    status: completed
    dependencies:
      - phase7-docs
  - id: final-check-types
    content: "–ü–†–û–í–ï–†–ö–ê: >= 5 —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ"
    status: completed
    dependencies:
      - phase7-schema-doc-types
  - id: final-check-no-concat
    content: "–ü–†–û–í–ï–†–ö–ê: grep –Ω–µ—Ç SQL-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ –≤ backend"
    status: completed
    dependencies:
      - phase3-prisma-middleware-safe
      - phase3-reports-safe-sql
---

# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø)

## –§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

**–°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–ª–∏—Å—Ç–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫—É—Ä—Å–æ–≤–æ–π**–°–æ–∑–¥–∞—Ç—å [`docs/requirements-checklist.md`](docs/requirements-checklist.md) —Å –ø–æ–ª–Ω—ã–º —á–µ–∫–ª–∏—Å—Ç–æ–º –∏–∑ PDF –∏ –∫–∞—Ä—Ç–æ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ ‚Üí —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è".

## –§–∞–∑–∞ 1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ pnpm workspaces + Turborepo**–°–æ–∑–¥–∞—Ç—å –≤ –∫–æ—Ä–Ω–µ:

- [`pnpm-workspace.yaml`](pnpm-workspace.yaml) ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ—Ä–∫—Å–ø–µ–π—Å–æ–≤
- [`turbo.json`](turbo.json) ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Turborepo
- –ù–æ–≤—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π [`package.json`](package.json) —Å workspaces-—Å–∫—Ä–∏–ø—Ç–∞–º–∏
- [`.npmrc`](.npmrc)

**–ú–∏–≥—Ä–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ apps/frontend**–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ Next.js —Ñ–∞–π–ª—ã –≤ [`apps/frontend/`](apps/frontend/):

- `app/`, `components/`, `contexts/`, `lib/`, `public/`
- `middleware.ts`, `next.config.ts`, `tsconfig.json`, `postcss.config.mjs`
- `biome.json`, `components.json`, `tailwind.config.ts`

**–û—á–∏—Å—Ç–∫–∞**–£–¥–∞–ª–∏—Ç—å: `__tests__/`, `vitest.config.ts`, `vitest.setup.ts`, `package-lock.json`, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ vitest/testing-library

## –§–∞–∑–∞ 2: –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ë–î (packages/db)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ packages/db**

```javascript
packages/db/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îú‚îÄ‚îÄ sql/
‚îÇ   ‚îú‚îÄ‚îÄ 001_triggers.sql
‚îÇ   ‚îú‚îÄ‚îÄ 002_functions.sql
‚îÇ   ‚îú‚îÄ‚îÄ 003_views.sql
‚îÇ   ‚îî‚îÄ‚îÄ 004_indexes.sql
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ seed.ts
‚îÇ   ‚îî‚îÄ‚îÄ apply-sql.ts
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
```

**–°–•–ï–ú–ê –ë–î (13 –¢–ê–ë–õ–ò–¶) ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–°–ß–Å–¢ –¢–ò–ü–û–í**

### –ü—Ä–∞–≤–∏–ª–æ –ø–æ–¥—Å—á—ë—Ç–∞:

- TEXT x3 = **1 —Ç–∏–ø** (TEXT)
- UUID x2 = **1 —Ç–∏–ø** (UUID)
- TIMESTAMPTZ x2 = **1 —Ç–∏–ø** (TIMESTAMPTZ)

–ù—É–∂–Ω–æ: –º–∏–Ω–∏–º—É–º 5 **—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö** —Ç–∏–ø–æ–≤ –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ.---

### 1. users ‚Äî 8 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                UUID PRIMARY KEY DEFAULT gen_random_uuid()
email             TEXT UNIQUE NOT NULL
password_hash     TEXT NOT NULL
full_name         TEXT NOT NULL
role              VARCHAR(50) DEFAULT 'user'
is_active         BOOLEAN DEFAULT true
created_at        TIMESTAMPTZ DEFAULT NOW()
login_count       INTEGER DEFAULT 0
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, TEXT, VARCHAR, BOOLEAN, TIMESTAMPTZ, INTEGER = **6 —Ç–∏–ø–æ–≤** ‚úì---

### 2. user_profiles (1:1 —Å users) ‚Äî 8 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                    UUID PRIMARY KEY DEFAULT gen_random_uuid()
user_id               UUID UNIQUE NOT NULL REFERENCES users ON DELETE CASCADE
bio                   TEXT
avatar_url            TEXT
timezone              VARCHAR(100) DEFAULT 'UTC'
date_of_birth         DATE
notification_enabled  BOOLEAN DEFAULT true
theme_preference      SMALLINT DEFAULT 0 CHECK(theme_preference >= 0 AND theme_preference <= 2)
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, TEXT, VARCHAR, DATE, BOOLEAN, SMALLINT = **6 —Ç–∏–ø–æ–≤** ‚úì---

### 3. habits (1:N –æ—Ç users) ‚Äî 10 –∫–æ–ª–æ–Ω–æ–∫, 7 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
user_id         UUID NOT NULL REFERENCES users ON DELETE CASCADE
name            TEXT NOT NULL
description     TEXT
type            VARCHAR(10) CHECK(type IN ('good', 'bad')) NOT NULL
color           VARCHAR(7) DEFAULT '#6366f1'
priority        SMALLINT DEFAULT 0 CHECK(priority >= 0 AND priority <= 10)
is_archived     BOOLEAN DEFAULT false
display_order   INTEGER DEFAULT 0
created_at      TIMESTAMPTZ DEFAULT NOW()
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, TEXT, VARCHAR, SMALLINT, BOOLEAN, INTEGER, TIMESTAMPTZ = **7 —Ç–∏–ø–æ–≤** ‚úì---

### 4. habit_schedules (1:N –æ—Ç habits) ‚Äî 8 –∫–æ–ª–æ–Ω–æ–∫, 7 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                UUID PRIMARY KEY DEFAULT gen_random_uuid()
habit_id          UUID NOT NULL REFERENCES habits ON DELETE CASCADE
frequency_type    VARCHAR(20) CHECK(frequency_type IN ('daily', 'weekly', 'monthly', 'custom'))
frequency_value   INTEGER DEFAULT 1 CHECK(frequency_value > 0)
weekdays_mask     SMALLINT DEFAULT 127 -- –±–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞ –¥–ª—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
start_date        DATE NOT NULL
end_date          DATE
is_active         BOOLEAN DEFAULT true
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, INTEGER, SMALLINT, DATE, BOOLEAN = **6 —Ç–∏–ø–æ–≤** ‚úì---

### 5. habit_checkins (–¢–†–ê–ù–ó–ê–ö–¶–ò–û–ù–ù–ê–Ø, 10000+) ‚Äî 9 –∫–æ–ª–æ–Ω–æ–∫, 7 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
habit_id            UUID NOT NULL REFERENCES habits ON DELETE CASCADE
user_id             UUID NOT NULL REFERENCES users ON DELETE CASCADE
checkin_date        DATE NOT NULL
checkin_time        TIME DEFAULT CURRENT_TIME
notes               TEXT
mood_rating         SMALLINT CHECK(mood_rating >= 1 AND mood_rating <= 5)
duration_minutes    INTEGER
created_at          TIMESTAMPTZ DEFAULT NOW()

UNIQUE(habit_id, checkin_date)
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, DATE, TIME, TEXT, SMALLINT, INTEGER, TIMESTAMPTZ = **7 —Ç–∏–ø–æ–≤** ‚úì---

### 6. tags ‚Äî 7 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
name            VARCHAR(100) UNIQUE NOT NULL
slug            TEXT UNIQUE NOT NULL  -- –¥–ª—è URL-friendly –∏–º–µ–Ω–∏
color           VARCHAR(7) DEFAULT '#gray'
usage_count     INTEGER DEFAULT 0
is_system       BOOLEAN DEFAULT false  -- —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å
created_at      TIMESTAMPTZ DEFAULT NOW()
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, TEXT, INTEGER, BOOLEAN, TIMESTAMPTZ = **6 —Ç–∏–ø–æ–≤** ‚úì---

### 7. habit_tags (N:M habits‚Üîtags) ‚Äî 7 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
habit_id        UUID NOT NULL REFERENCES habits ON DELETE CASCADE
tag_id          UUID NOT NULL REFERENCES tags ON DELETE CASCADE
priority        SMALLINT DEFAULT 0
is_primary      BOOLEAN DEFAULT false
assigned_by     VARCHAR(50) DEFAULT 'user'  -- 'user' –∏–ª–∏ 'auto'
assigned_at     TIMESTAMPTZ DEFAULT NOW()

UNIQUE(habit_id, tag_id)
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, SMALLINT, BOOLEAN, VARCHAR, TIMESTAMPTZ = **5 —Ç–∏–ø–æ–≤** ‚úì---

### 8. reminders (1:N –æ—Ç habits) ‚Äî 8 –∫–æ–ª–æ–Ω–æ–∫, 7 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
habit_id            UUID NOT NULL REFERENCES habits ON DELETE CASCADE
reminder_time       TIME NOT NULL
days_of_week        SMALLINT DEFAULT 127  -- –±–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
notification_text   TEXT
delivery_method     VARCHAR(20) DEFAULT 'push' CHECK(delivery_method IN ('push', 'email', 'sms'))
is_active           BOOLEAN DEFAULT true
created_at          TIMESTAMPTZ DEFAULT NOW()
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, TIME, SMALLINT, TEXT, VARCHAR, BOOLEAN, TIMESTAMPTZ = **7 —Ç–∏–ø–æ–≤** ‚úì---

### 9. habit_stats (–∞–≥—Ä–µ–≥–∞—Ç—ã –æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞) ‚Äî 9 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
habit_id            UUID UNIQUE NOT NULL REFERENCES habits ON DELETE CASCADE
total_checkins      INTEGER DEFAULT 0
current_streak      INTEGER DEFAULT 0
longest_streak      INTEGER DEFAULT 0
completion_rate     NUMERIC(5,2) DEFAULT 0.00
average_mood        NUMERIC(3,2)  -- —Å—Ä–µ–¥–Ω–∏–π mood –∏–∑ checkins
last_checkin_at     DATE
updated_at          TIMESTAMPTZ DEFAULT NOW()
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, INTEGER, NUMERIC, DATE, TIMESTAMPTZ = **5 —Ç–∏–ø–æ–≤** ‚úì---

### 10. audit_log (–∞—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π) ‚Äî 9 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
table_name      VARCHAR(100) NOT NULL
operation       VARCHAR(10) CHECK(operation IN ('INSERT', 'UPDATE', 'DELETE')) NOT NULL
record_id       UUID
user_id         UUID  -- –∏–∑ SET LOCAL app.user_id
old_data        JSONB
new_data        JSONB
ip_address      INET  -- IP –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
changed_at      TIMESTAMPTZ DEFAULT NOW()

CREATE INDEX idx_audit_changed_at ON audit_log(changed_at DESC);
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, JSONB, INET, TIMESTAMPTZ = **5 —Ç–∏–ø–æ–≤** ‚úì---

### 11. _manual_migrations (–∫–æ–Ω—Ç—Ä–æ–ª—å SQL-–º–∏–≥—Ä–∞—Ü–∏–π) ‚Äî 6 –∫–æ–ª–æ–Ω–æ–∫, 5 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
name                VARCHAR(255) UNIQUE NOT NULL
checksum            VARCHAR(64)  -- SHA-256 hash
applied_at          TIMESTAMPTZ DEFAULT NOW()
execution_time_ms   INTEGER
status              VARCHAR(20) DEFAULT 'success' CHECK(status IN ('success', 'failed'))
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, TIMESTAMPTZ, INTEGER = **4 —Ç–∏–ø–∞** ‚ùå**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**

```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
name                VARCHAR(255) UNIQUE NOT NULL
checksum            CHAR(64)  -- SHA-256 hash —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
applied_at          TIMESTAMPTZ DEFAULT NOW()
execution_time_ms   INTEGER
status              VARCHAR(20) DEFAULT 'success' CHECK(status IN ('success', 'failed'))
applied_by          TEXT  -- –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ 'system'
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, CHAR, TIMESTAMPTZ, INTEGER, TEXT = **6 —Ç–∏–ø–æ–≤** ‚úì---

### 12. batch_import_jobs ‚Äî 9 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
user_id         UUID REFERENCES users ON DELETE SET NULL
entity_type     VARCHAR(50) NOT NULL  -- 'habits', 'checkins', etc
status          VARCHAR(20) CHECK(status IN ('pending', 'processing', 'completed', 'failed'))
total_records   INTEGER DEFAULT 0
success_count   INTEGER DEFAULT 0
error_count     INTEGER DEFAULT 0
started_at      TIMESTAMPTZ DEFAULT NOW()
completed_at    TIMESTAMPTZ
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, INTEGER, TIMESTAMPTZ = **4 —Ç–∏–ø–∞** ‚ùå**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**

```sql
id                  UUID PRIMARY KEY DEFAULT gen_random_uuid()
user_id             UUID REFERENCES users ON DELETE SET NULL
entity_type         VARCHAR(50) NOT NULL
status              VARCHAR(20) CHECK(status IN ('pending', 'processing', 'completed', 'failed'))
total_records       INTEGER DEFAULT 0
success_count       INTEGER DEFAULT 0
error_count         INTEGER DEFAULT 0
progress_percent    NUMERIC(5,2) DEFAULT 0.00
file_size_bytes     BIGINT
started_at          TIMESTAMPTZ DEFAULT NOW()
completed_at        TIMESTAMPTZ
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, VARCHAR, INTEGER, NUMERIC, BIGINT, TIMESTAMPTZ = **6 —Ç–∏–ø–æ–≤** ‚úì---

### 13. batch_import_errors ‚Äî 7 –∫–æ–ª–æ–Ω–æ–∫, 6 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì

```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
job_id          UUID NOT NULL REFERENCES batch_import_jobs ON DELETE CASCADE
row_number      INTEGER
record_data     JSONB NOT NULL
error_message   TEXT NOT NULL
error_code      VARCHAR(50)
created_at      TIMESTAMPTZ DEFAULT NOW()
```

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã:** UUID, INTEGER, JSONB, TEXT, VARCHAR, TIMESTAMPTZ = **6 —Ç–∏–ø–æ–≤** ‚úì---**–ò—Ç–æ–≥–æ —Ç–∏–ø–æ–≤ –≤ PostgreSQL:**

- UUID
- TEXT
- VARCHAR(N)
- CHAR(N)
- INTEGER
- BIGINT
- SMALLINT
- NUMERIC(p,s)
- BOOLEAN
- DATE
- TIME
- TIMESTAMPTZ
- JSONB
- INET

**–ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç >= 5 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤ ‚úì**---**SQL –æ–±—ä–µ–∫—Ç—ã ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û**

### sql/001_triggers.sql

```sql
-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä—É—á–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
CREATE TABLE IF NOT EXISTS _manual_migrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) UNIQUE NOT NULL,
  checksum CHAR(64),
  applied_at TIMESTAMPTZ DEFAULT NOW(),
  execution_time_ms INTEGER,
  status VARCHAR(20) DEFAULT 'success' CHECK(status IN ('success', 'failed')),
  applied_by TEXT
);

-- –§–£–ù–ö–¶–ò–Ø –ê–£–î–ò–¢–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û: OLD+NEW –Ω–∞ UPDATE, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RETURN, user_id)
CREATE OR REPLACE FUNCTION audit_trigger_fn() RETURNS TRIGGER AS $$
DECLARE
  v_user_id UUID;
BEGIN
  -- –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ SET LOCAL app.user_id (–µ—Å–ª–∏ –µ—Å—Ç—å)
  BEGIN
    v_user_id := nullif(current_setting('app.user_id', true), '')::UUID;
  EXCEPTION WHEN OTHERS THEN
    v_user_id := NULL;
  END;

  -- –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞—É–¥–∏—Ç
  INSERT INTO audit_log (table_name, operation, record_id, user_id, old_data, new_data, changed_at)
  VALUES (
    TG_TABLE_NAME::VARCHAR,
    TG_OP::VARCHAR,
    COALESCE(NEW.id, OLD.id),
    v_user_id,
    CASE WHEN TG_OP IN ('UPDATE', 'DELETE') THEN row_to_json(OLD)::jsonb ELSE NULL END,
    CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN row_to_json(NEW)::jsonb ELSE NULL END,
    NOW()
  );

  -- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π RETURN
  IF TG_OP = 'DELETE' THEN
    RETURN OLD;
  ELSE
    RETURN NEW;
  END IF;
END;
$$ LANGUAGE plpgsql;

-- –¢—Ä–∏–≥–≥–µ—Ä—ã –∞—É–¥–∏—Ç–∞
CREATE TRIGGER habits_audit 
  AFTER INSERT OR UPDATE OR DELETE ON habits
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_fn();

CREATE TRIGGER habit_checkins_audit
  AFTER INSERT OR UPDATE OR DELETE ON habit_checkins
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_fn();

CREATE TRIGGER tags_audit
  AFTER INSERT OR UPDATE OR DELETE ON tags
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_fn();

CREATE TRIGGER reminders_audit
  AFTER INSERT OR UPDATE OR DELETE ON reminders
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_fn();

-- –¢–†–ò–ì–ì–ï–† –ê–ì–†–ï–ì–ê–¢–û–í
CREATE OR REPLACE FUNCTION update_habit_stats() RETURNS TRIGGER AS $$
DECLARE
  v_total INTEGER;
  v_avg_mood NUMERIC;
BEGIN
  IF TG_OP = 'INSERT' THEN
    -- –í—ã—á–∏—Å–ª—è–µ–º –∞–≥—Ä–µ–≥–∞—Ç—ã
    SELECT COUNT(*), AVG(mood_rating)
    INTO v_total, v_avg_mood
    FROM habit_checkins
    WHERE habit_id = NEW.habit_id;
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º habit_stats
    INSERT INTO habit_stats (habit_id, total_checkins, average_mood, last_checkin_at, updated_at)
    VALUES (NEW.habit_id, v_total, v_avg_mood, NEW.checkin_date, NOW())
    ON CONFLICT (habit_id) DO UPDATE SET
      total_checkins = v_total,
      average_mood = v_avg_mood,
      last_checkin_at = GREATEST(habit_stats.last_checkin_at, NEW.checkin_date),
      updated_at = NOW();
      
  ELSIF TG_OP = 'DELETE' THEN
    -- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
    SELECT COUNT(*), AVG(mood_rating)
    INTO v_total, v_avg_mood
    FROM habit_checkins
    WHERE habit_id = OLD.habit_id;
    
    UPDATE habit_stats SET
      total_checkins = v_total,
      average_mood = v_avg_mood,
      updated_at = NOW()
    WHERE habit_id = OLD.habit_id;
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER habit_checkins_update_stats
  AFTER INSERT OR DELETE ON habit_checkins
  FOR EACH ROW EXECUTE FUNCTION update_habit_stats();
```



### sql/002_functions.sql

```sql
-- –°–ö–ê–õ–Ø–†–ù–ê–Ø: —Ä–∞—Å—á—ë—Ç completion rate
CREATE OR REPLACE FUNCTION calc_completion_rate(
  p_user_id UUID,
  p_from DATE,
  p_to DATE
) RETURNS NUMERIC AS $$
DECLARE
  v_expected INTEGER;
  v_actual INTEGER;
BEGIN
  -- –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª-–≤–æ (–¥–Ω–∏ * –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏)
  SELECT COUNT(DISTINCT h.id) * (p_to - p_from + 1)
  INTO v_expected
  FROM habits h
  WHERE h.user_id = p_user_id AND NOT h.is_archived;
  
  -- –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª-–≤–æ checkins
  SELECT COUNT(*)
  INTO v_actual
  FROM habit_checkins hc
  JOIN habits h ON h.id = hc.habit_id
  WHERE h.user_id = p_user_id
    AND hc.checkin_date BETWEEN p_from AND p_to;
  
  IF v_expected = 0 THEN
    RETURN 0;
  END IF;
  
  RETURN ROUND((v_actual::NUMERIC / v_expected) * 100, 2);
END;
$$ LANGUAGE plpgsql;

-- –¢–ê–ë–õ–ò–ß–ù–ê–Ø: –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º
CREATE OR REPLACE FUNCTION report_user_habits(
  p_user_id UUID,
  p_from DATE,
  p_to DATE
) RETURNS TABLE(
  habit_id UUID,
  habit_name TEXT,
  habit_type VARCHAR,
  total_checkins BIGINT,
  completion_rate NUMERIC,
  last_checkin DATE
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    h.id,
    h.name,
    h.type,
    COUNT(hc.id) as total_checkins,
    ROUND(
      (COUNT(hc.id)::NUMERIC / NULLIF((p_to - p_from + 1), 0)) * 100, 
      2
    ) as completion_rate,
    MAX(hc.checkin_date) as last_checkin
  FROM habits h
  LEFT JOIN habit_checkins hc ON hc.habit_id = h.id 
    AND hc.checkin_date BETWEEN p_from AND p_to
  WHERE h.user_id = p_user_id
  GROUP BY h.id, h.name, h.type
  ORDER BY total_checkins DESC;
END;
$$ LANGUAGE plpgsql;
```



### sql/003_views.sql

```sql
-- VIEW 1: –°–≤–æ–¥–∫–∞ –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE OR REPLACE VIEW v_user_habit_summary AS
SELECT 
  u.id as user_id,
  u.email,
  u.full_name,
  COUNT(DISTINCT h.id) as total_habits,
  COUNT(DISTINCT CASE WHEN h.type = 'good' THEN h.id END) as good_habits,
  COUNT(DISTINCT CASE WHEN h.type = 'bad' THEN h.id END) as bad_habits,
  COALESCE(SUM(hs.total_checkins), 0) as total_checkins,
  MAX(hs.last_checkin_at) as last_activity
FROM users u
LEFT JOIN habits h ON h.user_id = u.id AND NOT h.is_archived
LEFT JOIN habit_stats hs ON hs.habit_id = h.id
GROUP BY u.id, u.email, u.full_name;

-- VIEW 2: –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
CREATE OR REPLACE VIEW v_daily_completion AS
SELECT 
  hc.checkin_date,
  COUNT(*) as total_checkins,
  COUNT(DISTINCT hc.user_id) as active_users,
  COUNT(DISTINCT hc.habit_id) as habits_completed,
  ROUND(AVG(hc.mood_rating), 2) as avg_mood,
  SUM(hc.duration_minutes) as total_minutes
FROM habit_checkins hc
GROUP BY hc.checkin_date
ORDER BY hc.checkin_date DESC;

-- VIEW 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–≥–æ–≤
CREATE OR REPLACE VIEW v_tag_usage AS
SELECT 
  t.id as tag_id,
  t.name as tag_name,
  t.color,
  COUNT(ht.habit_id) as usage_count,
  COUNT(DISTINCT ht.habit_id) as unique_habits,
  MAX(ht.assigned_at) as last_used
FROM tags t
LEFT JOIN habit_tags ht ON ht.tag_id = t.id
GROUP BY t.id, t.name, t.color
ORDER BY usage_count DESC;
```



### sql/004_indexes.sql

```sql
CREATE INDEX IF NOT EXISTS idx_habits_user_id ON habits(user_id) WHERE NOT is_archived;
CREATE INDEX IF NOT EXISTS idx_habit_checkins_habit_date ON habit_checkins(habit_id, checkin_date DESC);
CREATE INDEX IF NOT EXISTS idx_habit_checkins_user_date ON habit_checkins(user_id, checkin_date DESC);
CREATE INDEX IF NOT EXISTS idx_habit_checkins_date ON habit_checkins(checkin_date DESC);
CREATE INDEX IF NOT EXISTS idx_audit_log_table_op_time ON audit_log(table_name, operation, changed_at DESC);
CREATE INDEX IF NOT EXISTS idx_audit_log_user_time ON audit_log(user_id, changed_at DESC) WHERE user_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_habit_tags_habit ON habit_tags(habit_id);
CREATE INDEX IF NOT EXISTS idx_habit_tags_tag ON habit_tags(tag_id);
```

**Seed ‚Äî 800 habits, 10000 checkins**[`scripts/seed.ts`](packages/db/scripts/seed.ts):

```typescript
import { PrismaClient } from '@prisma/client';
import { faker } from '@faker-js/faker';

faker.seed(12345); // –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô SEED

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Seeding database...');
  
  const users = await createUsers(100);
  const tags = await createTags(50);
  const habits = await createHabits(users, 800); // –ö–†–£–ü–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê
  await createHabitTags(habits, tags, 1500);
  await createSchedules(habits);
  await createReminders(habits, 600);
  await createCheckins(habits, users, 10000); // –¢–†–ê–ù–ó–ê–ö–¶–ò–û–ù–ù–ê–Ø
  
  console.log('‚úÖ Seeding completed!');
}
```

**–°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SQL ‚Äî —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º**[`scripts/apply-sql.ts`](packages/db/scripts/apply-sql.ts):

```typescript
import { PrismaClient } from '@prisma/client';
import fs from 'fs/promises';
import path from 'path';
import crypto from 'crypto';

const prisma = new PrismaClient();
const SQL_DIR = path.join(__dirname, '../sql');

const migrations = [
  '001_triggers.sql',
  '002_functions.sql',
  '003_views.sql',
  '004_indexes.sql'
];

async function applyMigration(filename: string) {
  const filepath = path.join(SQL_DIR, filename);
  const content = await fs.readFile(filepath, 'utf-8');
  const checksum = crypto.createHash('sha256').update(content).digest('hex');
  
  return prisma.$transaction(async (tx) => {
    const existing = await tx.$queryRaw<Array<{name: string}>>`
      SELECT name FROM _manual_migrations WHERE name = ${filename}
    `;
    
    if (existing.length > 0) {
      console.log(`‚è≠Ô∏è  ${filename} already applied`);
      return;
    }
    
    console.log(`üìù Applying ${filename}...`);
    const startTime = Date.now();
    
    await tx.$executeRawUnsafe(content);
    
    const executionTime = Date.now() - startTime;
    
    await tx.$executeRaw`
      INSERT INTO _manual_migrations (name, checksum, execution_time_ms, applied_by)
      VALUES (${filename}, ${checksum}, ${executionTime}, 'system')
    `;
    
    console.log(`‚úÖ ${filename} applied in ${executionTime}ms`);
  });
}
```



## –§–∞–∑–∞ 3: Backend –Ω–∞ NestJS ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û

**Prisma Middleware ‚Äî –ö–†–ò–¢–ò–ß–ù–û: –ë–ï–ó SQL-–ö–û–ù–ö–ê–¢–ï–ù–ê–¶–ò–ò**[`prisma/prisma.service.ts`](apps/backend/src/prisma/prisma.service.ts):

```typescript
import { Injectable, OnModuleInit } from '@nestjs/common';
import { PrismaClient } from '@repo/db';
import { AsyncLocalStorage } from 'async_hooks';

export const asyncLocalStorage = new AsyncLocalStorage<{ userId?: string }>();

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
    
    // Middleware: SET LOCAL app.user_id –ü–ê–†–ê–ú–ï–¢–†–ò–ó–û–í–ê–ù–ù–û
    this.$use(async (params, next) => {
      const store = asyncLocalStorage.getStore();
      const userId = store?.userId;
      
      if (userId) {
        // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ $executeRaw
        await this.$executeRaw`SET LOCAL app.user_id = ${userId}`;
        
        // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–±—ã–ª–æ):
        // await this.$executeRawUnsafe(`SET LOCAL app.user_id = '${userId}'`);
      }
      
      const result = await next(params);
      return result;
    });
  }
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–µ—Å–ª–∏ $executeRaw –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å SET LOCAL):**

```typescript
// –ï—Å–ª–∏ Prisma –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è SET LOCAL,
// –∏—Å–ø–æ–ª—å–∑—É–µ–º pg –Ω–∞–ø—Ä—è–º—É—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π:
import { Client } from 'pg';

this.$use(async (params, next) => {
  const store = asyncLocalStorage.getStore();
  const userId = store?.userId;
  
  if (userId) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π
    const client = new Client({ connectionString: process.env.DATABASE_URL });
    await client.connect();
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    await client.query('SET LOCAL app.user_id = $1', [userId]);
    await client.end();
  }
  
  return next(params);
});
```

**–ï—â—ë –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pg_catalog.set_config:**

```typescript
if (userId) {
  // ‚úÖ –ü–ê–†–ê–ú–ï–¢–†–ò–ó–û–í–ê–ù–û —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é PostgreSQL
  await this.$executeRaw`SELECT set_config('app.user_id', ${userId}, true)`;
}
```

**Auth Guard**[`auth/jwt-auth.guard.ts`](apps/backend/src/auth/jwt-auth.guard.ts):

```typescript
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  canActivate(context: ExecutionContext) {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    
    return asyncLocalStorage.run({ userId: user?.id }, () => {
      return super.canActivate(context);
    });
  }
}
```

**–û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏**

- Auth: POST `/auth/register`, POST `/auth/login`, GET `/auth/me`
- CRUD: habits, checkins, tags, reminders —á–µ—Ä–µ–∑ Prisma
- Reports: GET `/reports/user/:userId` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π SQL
- Batch: POST `/batch-import` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Swagger: `/api/docs`

## –§–∞–∑–∞ 4: –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

**–£–¥–∞–ª–µ–Ω–∏–µ Supabase**

- –£–¥–∞–ª–∏—Ç—å `@supabase/*` –∏–∑ package.json
- –£–¥–∞–ª–∏—Ç—å `lib/supabase/`
- –£–¥–∞–ª–∏—Ç—å `app/api/auth/callback/`

**API –∫–ª–∏–µ–Ω—Ç**[`lib/api/client.ts`](apps/frontend/lib/api/client.ts):

```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export async function apiCall<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const token = getToken(); // –∏–∑ cookie –∏–ª–∏ localStorage
  
  const res = await fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(token && { Authorization: `Bearer ${token}` }),
      ...options?.headers,
    },
  });
  
  if (!res.ok) throw new Error(`API error: ${res.statusText}`);
  return res.json();
}
```

**Server Actions**–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å [`authActions.ts`](apps/frontend/app/actions/authActions.ts), [`habitActions.ts`](apps/frontend/app/actions/habitActions.ts), [`completionActions.ts`](apps/frontend/app/actions/completionActions.ts) –¥–ª—è –≤—ã–∑–æ–≤–∞ backend API.**Middleware ‚Äî –ë–ï–ó —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤**[`middleware.ts`](apps/frontend/middleware.ts):

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { jwtVerify } from 'jose';

export async function middleware(request: NextRequest) {
  const token = request.cookies.get('access_token')?.value;
  
  const isAuthPage = request.nextUrl.pathname.startsWith('/login') || 
                     request.nextUrl.pathname.startsWith('/signup');
  
  if (!token && !isAuthPage) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
  
  // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT (–ë–ï–ó fetch –∫ backend)
  if (token) {
    try {
      const secret = new TextEncoder().encode(process.env.JWT_SECRET);
      await jwtVerify(token, secret);
    } catch {
      if (!isAuthPage) {
        return NextResponse.redirect(new URL('/login', request.url));
      }
    }
  }
  
  if (token && isAuthPage) {
    return NextResponse.redirect(new URL('/', request.url));
  }
  
  return NextResponse.next();
}
```



## –§–∞–∑–∞ 5: Docker Compose ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û

**docker-compose.yml**

```yaml
version: '3.9'

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: habit_tracker
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
    - "5432:5432"
    volumes:
    - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/habit_tracker
      JWT_SECRET: ${JWT_SECRET:-change-me}
      PORT: 3001
    ports:
    - "3001:3001"
    depends_on:
      db:
        condition: service_healthy

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
    environment:
      # ‚úÖ –í Docker –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
      NEXT_PUBLIC_API_URL: http://backend:3001
      API_URL: http://backend:3001
      JWT_SECRET: ${JWT_SECRET:-change-me}
    ports:
    - "3000:3000"
    depends_on:
    - backend

volumes:
  db_data:
```

**Environment —Ñ–∞–π–ª—ã**[`.env.example`](.env.example):

```javascript
JWT_SECRET=your-secret-key-here
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/habit_tracker
```

[`apps/frontend/.env.local.example`](apps/frontend/.env.local.example):

```javascript
# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –í–ù–ï Docker
NEXT_PUBLIC_API_URL=http://localhost:3001
API_URL=http://localhost:3001
JWT_SECRET=your-secret-key
```

[`apps/frontend/.env.docker`](apps/frontend/.env.docker):

```javascript
# –î–ª—è Docker Compose (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Dockerfile)
NEXT_PUBLIC_API_URL=http://backend:3001
API_URL=http://backend:3001
JWT_SECRET=your-secret-key
```



## –§–∞–∑–∞ 6: –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

[`docs/perf.md`](docs/perf.md) ‚Äî EXPLAIN ANALYZE –¥–æ/–ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (–º–∏–Ω–∏–º—É–º 2 –∑–∞–ø—Ä–æ—Å–∞).

## –§–∞–∑–∞ 7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [`docs/requirements-checklist.md`](docs/requirements-checklist.md)
- [`docs/schema.md`](docs/schema.md) ‚Äî **—Ç–∞–±–ª–∏—Ü—ã —Å —è–≤–Ω—ã–º –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º —Ç–∏–ø–æ–≤**
- [`docs/api.md`](docs/api.md)
- [`docs/perf.md`](docs/perf.md)
- [`docs/batch-import.md`](docs/batch-import.md)
- [`docs/security-notes.md`](docs/security-notes.md)
- [`README.md`](README.md)

---

## Definition of Done (–§–ò–ù–ê–õ–¨–ù–´–ô)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

‚úÖ 13 —Ç–∞–±–ª–∏—Ü –≤ –ë–î‚úÖ **–ö–ê–ñ–î–ê–Ø —Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç >= 5 –†–ê–ó–ù–´–• —Ç–∏–ø–æ–≤** (UUID, TEXT, VARCHAR, INTEGER, BOOLEAN –∏ —Ç.–¥.)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: `docs/schema.md` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º –∫–æ–ª–æ–Ω–æ–∫ –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: PK, FK (CASCADE), UNIQUE, CHECK, NOT NULL

### –î–∞–Ω–Ω—ã–µ

‚úÖ Seed: 800 habits, 10000 checkins, faker.seed(12345)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: `SELECT COUNT(*) FROM habits` = ~800, `SELECT COUNT(*) FROM habit_checkins` = ~10000

### SQL –æ–±—ä–µ–∫—Ç—ã

‚úÖ –ê—É–¥–∏—Ç-—Ç—Ä–∏–≥–≥–µ—Ä —Å user_id (UPDATE –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç old+new, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RETURN)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å habit —á–µ—Ä–µ–∑ API ‚Üí `SELECT * FROM audit_log WHERE table_name='habits' ORDER BY changed_at DESC LIMIT 1` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç user_id‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –∞–≥—Ä–µ–≥–∞—Ç–æ–≤: habit_stats –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å checkin ‚Üí `habit_stats.total_checkins` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è‚úÖ –§—É–Ω–∫—Ü–∏–∏: calc_completion_rate (—Å–∫–∞–ª—è—Ä–Ω–∞—è), report_user_habits (—Ç–∞–±–ª–∏—á–Ω–∞—è)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: `SELECT calc_completion_rate('<uuid>', '2024-01-01', '2024-12-31')`‚úÖ VIEW: v_user_habit_summary, v_daily_completion, v_tag_usage‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: `SELECT * FROM v_user_habit_summary LIMIT 5`‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã

### –ö–æ–Ω—Ç—Ä–æ–ª—å –º–∏–≥—Ä–∞—Ü–∏–π

‚úÖ –¢–∞–±–ª–∏—Ü–∞ `_manual_migrations` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ `pnpm db:sql` –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–Ω–æ–≤–æ

### Backend ‚Äî –ö–†–ò–¢–ò–ß–ù–û

‚úÖ **Prisma middleware –ë–ï–ó SQL-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `$executeRaw` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π –ò–õ–ò `set_config()`  
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `$executeRawUnsafe` —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π —Å—Ç—Ä–æ–∫  

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤ `prisma.service.ts` –ù–ï–¢ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤–∏–¥–∞ `` `SET ... = '${variable}'` ``‚úÖ –û—Ç—á—ë—Ç–Ω—ã–µ —ç–Ω–¥–ø–æ–π–Ω—Ç—ã: `$queryRaw` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤ –∫–æ–¥–µ –ù–ï–¢ SQL-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ (grep –≤ backend/src/)‚úÖ Batch import —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º‚úÖ Swagger: http://localhost:3001/api/docs

### Frontend

‚úÖ –ù–ï–¢ Supabase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π‚úÖ Middleware –ë–ï–ó —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (—Ç–æ–ª—å–∫–æ jwtVerify)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤ `middleware.ts` –ù–ï–¢ `fetch()` –∏–ª–∏ `apiCall()`

### Docker

‚úÖ docker-compose —Ä–∞–±–æ—Ç–∞–µ—Ç‚úÖ Frontend –≤ docker –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `NEXT_PUBLIC_API_URL=http://backend:3001`‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π dev –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `NEXT_PUBLIC_API_URL=http://localhost:3001`‚úÖ –°–µ–∫—Ä–µ—Ç—ã –≤ .env, –µ—Å—Ç—å .env.example

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

‚úÖ `docs/perf.md` —Å EXPLAIN ANALYZE (–¥–æ/–ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–æ–≤, –º–∏–Ω–∏–º—É–º 2 –∑–∞–ø—Ä–æ—Å–∞)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

‚úÖ `docs/schema.md` —Å–æ–¥–µ—Ä–∂–∏—Ç:

- –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
- –î–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã: –∫–æ–ª–æ–Ω–∫–∏ + —Ç–∏–ø—ã + **–ø–æ–¥—Å—á—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ >= 5**
- ER-–¥–∏–∞–≥—Ä–∞–º–º–∞ (Mermaid)  

‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ docs/ —Ñ–∞–π–ª—ã

### –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –≤ —Å—Ö–µ–º–µ
cat docs/schema.md | grep "–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã"
# –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å >= 5 —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏ –≤ Prisma middleware
grep -n "executeRawUnsafe.*app.user_id" apps/backend/src/prisma/prisma.service.ts
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –û–®–ò–ë–ö–ê!)

grep -n "executeRaw.*app.user_id" apps/backend/src/prisma/prisma.service.ts
# –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å—Ç—Ä–æ–∫–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ –≤ backend
grep -rn "\\${\|\\+" apps/backend/src/ | grep -i "select\|insert\|update\|delete" | grep -v "test"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å SQL —Å –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–µ–π

# 4. –ó–∞–ø—É—Å–∫
pnpm install
pnpm docker:up
pnpm db:migrate
pnpm db:sql
pnpm db:seed

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker -c "
  SELECT table_name, COUNT(*) FROM (
    SELECT 'users' as table_name, COUNT(*) FROM users
    UNION ALL SELECT 'habits', COUNT(*) FROM habits
    UNION ALL SELECT 'habit_checkins', COUNT(*) FROM habit_checkins
  ) t GROUP BY table_name;
"

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏—Ç–∞ —Å user_id
# –°–æ–∑–¥–∞—Ç—å habit —á–µ—Ä–µ–∑ Swagger ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å audit_log
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker -c "
  SELECT user_id, operation, changed_at 
  FROM audit_log 
  WHERE table_name = 'habits' 
  ORDER BY changed_at DESC 
  LIMIT 5;
"
# user_id –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å NULL

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ VIEW
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker -c "
  SELECT * FROM v_user_habit_summary LIMIT 3;
"

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker -c "
  SELECT * FROM report_user_habits(
    (SELECT id FROM users LIMIT 1),
    '2024-01-01'::date,
    '2024-12-31'::date
  );
"
```

---