# Habit Tracker — Правила проекта для AI

## О проекте

Это курсовая работа по дисциплине «Базы данных».

**Технологии:**
- Backend: NestJS + Prisma ORM + PostgreSQL 16
- Frontend: Next.js 15 + TypeScript
- Монорепозиторий: pnpm workspaces + Turborepo
- Контейнеризация: Docker Compose

## Структура

```
apps/
  backend/     # NestJS API
  frontend/    # Next.js app
packages/
  db/          # Prisma schema + SQL миграции
docs/          # Документация
```

## Критические правила безопасности

### ❌ ЗАПРЕЩЕНО (штрафы в оценке):

1. **Секреты в коде** (оценка не выше «3»)
   - НЕ хранить DATABASE_URL, JWT_SECRET в коде
   - Только в `.env` (который в `.gitignore`)

2. **SQL-конкатенация** (оценка не выше «4»)
   - НЕ использовать `$executeRawUnsafe` с конкатенацией
   - НЕ использовать template literals с `${}`
   - Только параметризованные запросы:
     ```typescript
     // ✅ Правильно
     await prisma.$queryRaw`SELECT * FROM habits WHERE id = ${id}`;
     
     // ❌ Неправильно
     await prisma.$executeRawUnsafe(`SELECT * FROM habits WHERE id = '${id}'`);
     ```

### ✅ Обязательно:

- Параметризация SQL (Prisma $queryRaw)
- Секреты в .env
- Хеширование паролей (bcrypt)
- JWT-токены
- Валидация входных данных

## База данных

### Требования
- 13 таблиц (✅ выполнено)
- Каждая >= 5 **РАЗНЫХ** типов (UUID, TEXT, VARCHAR, INTEGER, BOOLEAN, DATE, TIME, TIMESTAMPTZ, SMALLINT, NUMERIC, JSONB, INET, CHAR, BIGINT)
- Триггеры: аудит + агрегаты
- Функции: скалярная + табличная
- VIEW: 3 представления
- Индексы: 10 индексов

### Важно
- user_id в audit_log берётся из `SET LOCAL app.user_id` (Prisma middleware + AsyncLocalStorage)
- Триггеры обновляют habit_stats автоматически

## Скрипты

```bash
# База данных
pnpm db:generate      # Генерация Prisma Client
pnpm db:migrate       # Prisma миграции
pnpm db:sql           # SQL (триггеры, функции, VIEW, индексы)
pnpm db:seed          # Заполнение БД

# Разработка
pnpm dev              # Всё
pnpm dev:frontend     # Только frontend
pnpm dev:backend      # Только backend

# Docker
pnpm docker:up        # Запуск контейнеров
pnpm docker:down      # Остановка
```

## Особенности кода

### Prisma Middleware (КРИТИЧНО!)

```typescript
// ✅ Правильная параметризация для SET LOCAL
this.$use(async (params, next) => {
  const store = asyncLocalStorage.getStore();
  const userId = store?.userId;
  
  if (userId) {
    // ✅ Параметризованный запрос
    await this.$executeRaw`SELECT set_config('app.user_id', ${userId}, true)`;
  }
  
  return next(params);
});
```

### AsyncLocalStorage для user_id

```typescript
// jwt-auth.guard.ts
return asyncLocalStorage.run({ userId: user?.id }, () => {
  return super.canActivate(context);
});
```

### Отчёты с параметризацией

```typescript
// ✅ Правильно
return await this.prisma.$queryRaw`
  SELECT * FROM report_user_habits(
    ${userId}::uuid,
    ${from}::date,
    ${to}::date
  )
`;
```

## Документация

- `README.md` — основная
- `QUICKSTART.md` — быстрый старт
- `docs/schema.md` — схема БД с ER-диаграммой
- `docs/api.md` — API
- `docs/perf.md` — производительность (EXPLAIN ANALYZE)
- `docs/batch-import.md` — batch import
- `docs/security-notes.md` — безопасность
- `docs/requirements-checklist.md` — чеклист требований

## При изменениях

1. **БД**: обновить schema.prisma → `pnpm db:generate`
2. **SQL**: добавить в `packages/db/sql/` → запустить `pnpm db:sql`
3. **Backend**: следовать структуре модулей NestJS
4. **Frontend**: использовать server actions для API
5. **Документация**: обновить соответствующий файл в `docs/`

## Тестирование

```bash
# Проверка данных
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker \
  -c "SELECT 'users' as t, COUNT(*) FROM users;"

# Проверка триггеров
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker \
  -c "SELECT * FROM audit_log ORDER BY changed_at DESC LIMIT 5;"

# Проверка VIEW
docker exec -it habit_tracker_db psql -U postgres -d habit_tracker \
  -c "SELECT * FROM v_user_habit_summary LIMIT 5;"
```

## Swagger UI

http://localhost:3001/api/docs

## Статус проекта

✅ **Готов к защите курсовой работы**

Все требования выполнены:
- 13 таблиц с >= 5 разных типов ✅
- Ограничения целостности ✅
- Триггеры + функции + VIEW + индексы ✅
- CRUD API + Swagger ✅
- Batch import ✅
- Docker Compose ✅
- Безопасность (параметризация, секреты в .env) ✅
- Полная документация ✅

