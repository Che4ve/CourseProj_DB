# –ó–∞–º–µ—Ç–∫–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üîê –û–±–∑–æ—Ä –º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞—Ç–∞–∫.

---

## 1. –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π

### ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Prisma ORM

**–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –∏—Å–ø–æ–ª—å–∑—É—é—Ç Prisma ORM**, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã:

```typescript
// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û: Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ—Ç
await prisma.user.findUnique({
  where: { email: userEmail }  // –ø–∞—Ä–∞–º–µ—Ç—Ä —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç—Å—è
});

// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û: Tagged template –¥–ª—è raw SQL
await prisma.$executeRaw`
  SELECT set_config('app.user_id', ${userId}, true)
`;
```

### ‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: DDL-–∫–æ–º–∞–Ω–¥—ã –∏–∑ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ —Å `$executeRawUnsafe`** ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL-–º–∏–≥—Ä–∞—Ü–∏–π –∏–∑ —Ñ–∞–π–ª–æ–≤ `packages/db/sql/*.sql`:

   ```typescript
// packages/db/scripts/apply-sql.ts
// DDL –∏–∑ –î–û–í–ï–†–ï–ù–ù–´–• —Ñ–∞–π–ª–æ–≤, —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö —á–µ—Ä–µ–∑ Git
await client.query(content);  // –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ —Ñ–∞–π–ª–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:**
- SQL –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞, –∞ –Ω–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –§–∞–π–ª—ã –ø—Ä–æ—Ö–æ–¥—è—Ç code review
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —á–µ—Ä–µ–∑ Git

---

## 2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### JWT —Ç–æ–∫–µ–Ω—ã

```typescript
// ‚úÖ –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö
const token = jwtService.sign({
  sub: user.id,
  email: user.email,
});
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤:**
- –í `httpOnly` cookies (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
- –¢–æ–∫–µ–Ω—ã –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ JavaScript –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –°—Ä–æ–∫ –∂–∏–∑–Ω–∏: 7 –¥–Ω–µ–π (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

### –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

```typescript
// ‚úÖ bcrypt —Å cost factor 10
const passwordHash = await bcrypt.hash(password, 10);
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è bcrypt (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏)
- Salt –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- Cost factor 10 (–±–∞–ª–∞–Ω—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏/–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

---

## 3. –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–æ–ª–µ–π –ø–æ —Å–µ—Ç–∏

### ‚ö†Ô∏è –í–∏–¥–∏–º–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è –≤ DevTools

**–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:** –ö–æ–≥–¥–∞ –≤—ã –≤–∏–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –≤ DevTools (–≤–∫–ª–∞–¥–∫–∞ Network) ‚Äî **—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ HTTPS**.

#### –ü–æ—á–µ–º—É –ø–∞—Ä–æ–ª—å –≤–∏–¥–µ–Ω –≤ DevTools:

1. **DevTools –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –î–û —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è HTTPS**
   - –ë—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ TLS/SSL
   - –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ –ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º

2. **POST body –≤–∏–¥–∏–º —Ç–æ–ª—å–∫–æ –≤–∞–º**
   - –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–∏—Ç payload
   - –í —Å–µ—Ç–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫

#### üîí –ó–∞—â–∏—Ç–∞ –≤ production:

```nginx
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ production
server {
    listen 443 ssl http2;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ TLS-–ø—Ä–æ—Ç–æ–∫–æ–ª—ã
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –ø–∞—Ä–æ–ª–µ–º:**

1. **–í –±—Ä–∞—É–∑–µ—Ä–µ (DevTools):**
   ```json
   {"email": "user@example.com", "password": "mypassword"}
   ```
   ‚Üì

2. **–í —Å–µ—Ç–∏ (–ø—Ä–∏ HTTPS):**
   ```
   <–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –ø–æ—Ç–æ–∫, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å>
   ```
   ‚Üì

3. **–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ TLS):**
   ```json
   {"email": "user@example.com", "password": "mypassword"}
   ```
   ‚Üì

4. **–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
   ```
   $2b$10$xQZJ8z9... (bcrypt hash, –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)
   ```

#### ‚ùå –ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:

```typescript
// ‚ùå –ü–õ–û–•–û: –ü–∞—Ä–æ–ª—å –≤ GET-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
fetch(`/api/login?password=${password}`);  // –ù–ò–ö–û–ì–î–ê!

// ‚ùå –ü–õ–û–•–û: –ü–∞—Ä–æ–ª—å –≤ URL
fetch(`/api/login/${email}/${password}`);  // –ù–ò–ö–û–ì–î–ê!

// ‚ùå –ü–õ–û–•–û: –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –≤ localStorage
localStorage.setItem('password', password);  // –ù–ò–ö–û–ì–î–ê!
```

#### ‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ü–†–ê–í–ò–õ–¨–ù–û:

```typescript
// ‚úÖ –•–û–†–û–®–û: POST —Å JSON body —á–µ—Ä–µ–∑ HTTPS
fetch('https://api.example.com/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, password })
});

// ‚úÖ –¢–æ–∫–µ–Ω –≤ httpOnly cookie
// ‚úÖ –ü–∞—Ä–æ–ª—å –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
// ‚úÖ –ü–∞—Ä–æ–ª—å —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```

---

## 4. –ó–∞—â–∏—Ç–∞ –æ—Ç XSS (Cross-Site Scripting)

### React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –≤—ã–≤–æ–¥

```tsx
// ‚úÖ React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç
<div>{user.fullName}</div>  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ fullName = "<script>alert(1)</script>"
```

### httpOnly cookies

```typescript
// –¢–æ–∫–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ JavaScript
document.cookie;  // –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç access_token
```

---

## 5. –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF (Cross-Site Request Forgery)

### JWT –≤ Bearer Authorization

```typescript
// ‚úÖ –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –Ω–µ –≤ cookie
headers: {
  'Authorization': `Bearer ${token}`
}
```

**–ó–∞—â–∏—Ç–∞:**
- –¢–æ–∫–µ–Ω –Ω—É–∂–Ω–æ —è–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–∞–π—Ç—ã –Ω–µ –º–æ–≥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å

---

## 6. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### Backend (NestJS)

```typescript
// class-validator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç DTO
export class RegisterDto {
  @IsEmail()
  email: string;

  @IsString()
  @MinLength(6)
  password: string;

  @IsString()
  @IsNotEmpty()
  fullName: string;
}
```

### Frontend

```tsx
// HTML5 –≤–∞–ª–∏–¥–∞—Ü–∏—è
<input
  type="email"
  required
  minLength={6}
/>
```

---

## 7. –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –¢—Ä–∏–≥–≥–µ—Ä audit_log

```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
CREATE TRIGGER habits_audit AFTER INSERT OR UPDATE OR DELETE ON habits
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_fn();
```

**–ß—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:**
- `user_id` ‚Äî –∫—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ (–∏–∑ `app.user_id`)
- `operation` ‚Äî INSERT/UPDATE/DELETE
- `old_data` / `new_data` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∏ –ø–æ—Å–ª–µ
- `timestamp` ‚Äî –∫–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–æ—à–ª–æ

---

## 8. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

### Constraints

```sql
-- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å email
ALTER TABLE users ADD CONSTRAINT users_email_unique UNIQUE (email);

-- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –ø—Ä–∏–≤—ã—á–∫–∏
ALTER TABLE habits ADD CONSTRAINT check_habit_type 
  CHECK (type IN ('daily', 'weekly', 'custom'));

-- –ù–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
ALTER TABLE habit_stats ADD CONSTRAINT check_positive_counts
  CHECK (total_expected >= 0 AND total_completed >= 0);
```

---

## 9. Rate Limiting (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è production)

### NestJS Throttler

```typescript
// –î–ª—è production: –¥–æ–±–∞–≤–∏—Ç—å rate limiting
import { ThrottlerModule } from '@nestjs/throttler';

@Module({
  imports: [
ThrottlerModule.forRoot({
      ttl: 60,        // 60 —Å–µ–∫—É–Ω–¥
      limit: 100,     // 100 –∑–∞–ø—Ä–æ—Å–æ–≤
    }),
  ],
})
```

---

## 10. Environment Variables

### ‚ö†Ô∏è –°–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# .env (–ù–ï –ö–û–ú–ú–ò–¢–ò–¢–¨ –í GIT!)
JWT_SECRET=production-secret-CHANGE-ME-xxxxxxxxxxxxx
DATABASE_URL=postgresql://user:password@localhost:5434/db
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω
- –î–æ–±–∞–≤—å—Ç–µ `.env` –≤ `.gitignore`
- –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ secrets manager (AWS Secrets Manager, HashiCorp Vault)

---

## üìã Checklist –¥–ª—è production

- [ ] **HTTPS –≤–µ–∑–¥–µ** (TLS 1.2+)
- [ ] **–°–∏–ª—å–Ω—ã–π JWT_SECRET** (–º–∏–Ω–∏–º—É–º 32 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞)
- [ ] **Rate limiting** –Ω–∞ API
- [ ] **CORS** –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- [ ] **Helmet.js** –¥–ª—è HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] **CSP** (Content Security Policy)
- [ ] **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`npm audit`)
- [ ] **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- [ ] **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** –ë–î
- [ ] **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –∞–ª–µ—Ä—Ç—ã

---

## üéì –í—ã–≤–æ–¥—ã

### –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

‚úÖ **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** (Prisma ORM)  
‚úÖ **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π** (bcrypt)  
‚úÖ **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å httpOnly cookies  
‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** (class-validator)  
‚úÖ **–ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π** (PostgreSQL —Ç—Ä–∏–≥–≥–µ—Ä—ã)  
‚úÖ **Constraints –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î**  
‚úÖ **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ** –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏  

### –î–ª—è production –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

‚ö†Ô∏è HTTPS (Let's Encrypt)  
‚ö†Ô∏è Rate limiting  
‚ö†Ô∏è WAF (Web Application Firewall)  
‚ö†Ô∏è Secrets manager  
‚ö†Ô∏è Security headers (Helmet.js)  

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 21 –¥–µ–∫–∞–±—Ä—è 2025
